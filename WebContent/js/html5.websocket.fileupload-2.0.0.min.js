/**Created by xianjun on 2015/1/4.*/(function(c){var b=function(e,d){var f=this;this.element=c(e);this.container=d.container||"body";this.isInput=d.isInput||true;this.isInline=true;this.concurrentHash=d.concurrentHash||3;this.concurrentUpload=d.concurrentUpload||3;this.concurrentHashCurrent=0;this.wsuri=d.wsuri;this.debugMode=d.debugMode||false;this.fileInput=c(a.fileInput).appendTo(this.container).on({change:c.proxy(this.fileSelect,this)});if(this.debugMode){a.template+=a.consTemplate}this.panel=c(a.template).appendTo(this.isInline?this.element:this.container).on({click:c.proxy(this.click,this)});this.attachDragEvents();this.initWS()};b.prototype={initWS:function(){if("WebSocket" in window){for(var e=0;e<this.concurrentUpload;e++){var d=new WebSocket(this.wsuri);d.onopen=this.onOpen(this);d.onmessage=this.onMessage(this);a.wsS.push(d)}}else{if("MozWebSocket" in window){for(var e=0;e<this.concurrentUpload;e++){var d=new MozWebSocket(this.wsuri);d.onopen=this.onOpen;d.onmessage=this.onMessage;a.wsS.push(d)}}else{alert("Websocket create error.")}}},onOpen:function(d){return function(){d.log("Websocket is opened.")}},onMessage:function(d){return function(h){var f=this;var g=JSON.parse(h.data);if(g.typeId=="uploadCommand"){d.log("文件完成："+parseInt(g.completePercent*65+35,10)+"%");c('[name="'+g.fileId+'"]').css("width",parseInt(g.completePercent*65+35,10)+"%");if(g.completePercent!=1){d.doUploadByCommand(f,g)}else{a.fileUploadStepMap[a.fileIdToFileNameMap[g.fileId]]=4;d.log("文件上传完成，开始上传下一个文件。");d.uploadNextFile(f);c('[name="'+g.fileId+'"]').closest(".progress").slideUp(1000).closest("td").css("color","green")}}}},hashNextFile:function(){if(a.filesToUpload.length!=0){var d=a.filesToUpload.shift();var e=new Worker("js/calculator.worker.fileId.js");e.addEventListener("message",this.handleHashWorkerEvent(d));a.workers[d.name]=e;this.doHashWork(d,e)}else{this.concurrentHashCurrent=0}},startHashFile:function(){for(var d,e;this.concurrentHashCurrent<this.concurrentHash;this.concurrentHashCurrent++){if(a.filesToUpload.length==0){break}d=a.filesToUpload.shift();e=new Worker("js/calculator.worker.fileId.js");e.addEventListener("message",this.handleHashWorkerEvent(d));a.workers[d.name]=e;this.doHashWork(d,e)}},doHashWork:function(f,e){a.fileUploadStepMap[f.name]=1;var h,k,g,j,d,m,l;l=function(i){e.postMessage({"message":i.target.result,"block":g})};m=function(i){if(g.end!==f.size){g.start+=k;g.end+=k;if(g.end>f.size){g.end=f.size}j=new FileReader();j.onload=l;d=f.slice(g.start,g.end);j.readAsArrayBuffer(d)}};k=512*1024;g={"file_size":f.size,"start":0};g.end=k>f.size?f.size:k;e.addEventListener("message",m);j=new FileReader();j.onload=l;d=f.slice(g.start,g.end);j.readAsArrayBuffer(d)},startUploadFile:function(e){if(a.wsS.length!=0){var d=a.wsS.shift();this.sendFileInfo(d,e);this.log("已从ws连接池中取出第一个ws连接，已发送["+e.name+"]文件信息，正在使用的ws连接加1.");a.filesUploaded.push(e)}else{a.filesHasHashed.push(e);a.fileUploadStepMap[e.name]=2;this.log("ws连接池中没有可用连接，已将["+e.name+"]放入已计算Hash文件池中.")}},uploadNextFile:function(d){if(a.filesHasHashed.length!=0){var e=a.filesHasHashed.shift();this.sendFileInfo(d,e);this.log("从已计算Hash文件池中取出文件["+e.name+"]，并发送文件信息.");a.filesUploaded.push(e)}else{a.wsS.push(d);this.log("没有已计算出Hash值的文件可上传，回收ws连接到连接池中.")}},sendFileInfo:function(d,g){var e={};e.fileName=g.name;e.fileSize=g.size;e.fileInfo=g.type;e.fileId=g.fileId;d.send(JSON.stringify(e));a.fileUploadStepMap[g.name]=3},doUploadByCommand:function(e,i){var j=a.fileIdToFileNameMap[i.fileId];var h=a.allFiles[j];if(h){var g=h.slice(i.indexStart,i.indexEnd);var d=new FileReader();d.onload=function(f){e.send(f.target.result)};d.readAsArrayBuffer(g)}else{this.uploadNextFile(e)}},handleHashWorkerEvent:function(e){var d=this;return function(g){if(g.data.result){this.concurrentHashCurrent--;var f=g.data.result;c('[name="'+e.name+'"]').find(".progress-bar").css("width","35%").attr("name",f);a.workers[e.name].terminate();delete a.workers[e.name];e["fileId"]=f;a.fileIdToFileNameMap[f]=e.name;d.log("文件已算出hash值，开始上传文件："+e.name);d.startUploadFile(e);d.hashNextFile()}else{c('[name="'+e.name+'"]').find(".progress-bar").css("width",g.data.block.end*35/g.data.block.file_size+"%")}}},click:function(g){var f=c(g.target).closest("button,td,.drop-zone");var k=this.panel.find("#addfile");var j=this.panel.find("tbody tr td:nth-last-child(1)");var h=this.panel.find(".drop-zone");if(f.is(k)||f.is(h)){c("#files").trigger("click")}else{if(f.is(j)){var d=f;var i=d.closest("tr").remove().find(".progress-bar").closest("td").find("span").html();this.doRemoveFileWork(i)}}},doRemoveFileWork:function(e){var d=a.fileUploadStepMap[e];switch(d){case 0:this.removeFileFromArray(e,a.filesToUpload);break;case 1:a.workers[e].terminate();this.concurrentHashCurrent--;this.removeFileFromArray(e);this.hashNextFile();break;case 2:this.removeFileFromArray(e,a.filesHasHashed);break;case 3:this.removeFileFromArray(e);break;case 4:this.removeFileFromArray(e,a.filesUploaded);break}},removeFileFromArray:function(f,e){delete a.allFiles[f];if(e){for(var d=0;d<e.length;d++){if(f===e[d].name){delete e[d];break}}}},attachDragEvents:function(){var d=document.getElementsByClassName("tablepanel");d[0].addEventListener("dragover",c.proxy(this.dragOver,this));d[0].addEventListener("drop",c.proxy(this.fileSelect,this))},dragOver:function(d){d.stopPropagation();d.preventDefault()},fileSelect:function(l){l.stopPropagation();l.preventDefault();this.hideDropzone();var h=l.dataTransfer?l.dataTransfer.files:l.target.files;var d=[];for(var g=0,j;j=h[g];g++){if(!a.allFiles[j.name]){var k='<div name="'+j.name+'" class="progress"><div class="progress-bar progress-bar-striped active" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div></div>';d.push("<tr><td><span>"+j.name+"</span>("+this.formatFileSize(j.size)+")"+k+'</td><td><span class="glyphicon glyphicon-remove"></span></td></tr>');a.allFiles[j.name]=j;a.filesToUpload.push(j);a.fileUploadStepMap[j.name]=0}}this.panel.find("tbody").append(d.join(""));this.startHashFile()},formatFileSize:function(d,h){var i;var e=h||2;for(var g in a.fileSizeFormats){var f=a.fileSizeFormats[g];i=d/f;if(i>=1&&i<1000){i=parseInt(i*Math.pow(10,e),10)/Math.pow(10,e)+g;break}}return i},hideDropzone:function(){c(".drop-zone").slideUp(500)},log:function(e){if(this.debugMode){var d=document.getElementById("console");var f=document.createElement("p");f.style.wordWrap="break-word";f.appendChild(document.createTextNode(e));d.appendChild(f);while(d.childNodes.length>50){d.removeChild(d.firstChild)}d.scrollTop=d.scrollHeight}}};c.fn.fileuploader=function(f){var d=Array.apply(null,arguments);d.shift();var e;this.each(function(){var i=c(this),h=i.data("fileuploader"),g=typeof f=="object"&&f;if(!h){i.data("fileuploader",(h=new b(this,c.extend({},c.fn.fileuploader.defaults,g))))}if(typeof f=="string"&&typeof h[f]=="function"){e=h[f].apply(h,d);if(e!==undefined){return false}}});if(e!=undefined){return e}else{return this}};c.fn.fileuploader.defaults={};c.fn.fileuploader.Constructor=b;var a={allFiles:{},filesToUpload:[],filesHasHashed:[],filesUploaded:[],fileIdToFileNameMap:{},fileUploadStepMap:{},workers:{},wsS:[],fileSizeFormats:{"Byte":Math.pow(10,0),"KB":Math.pow(10,3),"MB":Math.pow(10,6),"GB":Math.pow(10,9),"TB":Math.pow(10,12),"PB":Math.pow(10,15),"EB":Math.pow(10,18),"ZB":Math.pow(10,21),"YB":Math.pow(10,24),"BB":Math.pow(10,27)},headTemplate:'<div class="panel-heading"><h4>HTML5 fileupload</h4></div>',contTemplate:'<div class="tablepanel panel-body"><table class="table table-hover"><tbody></tbody></table>'+'<div class="drop-zone"><h1>Drop files here or click for select</h1>将文件拖放到这里或点击这里</div></div>',footTemplate:'<div class="panel-footer"><div class="btn-group">'+'<button class="btn btn-default btn-danger" id="addfile"><span class="glyphicon glyphicon-plus"></span>添加</button>'+"</div></div>",consTemplate:'<div id="console" class="well"></div>',finpTemplate:'<input id="files" type="file" multiple style="display: none"/>'};a.template='<div class="panel panel-default panel-info">'+a.headTemplate+a.contTemplate+a.footTemplate+"</div>";a.fileInput=a.finpTemplate;c.fn.fileuploader.UPGlobal=a})(jQuery);